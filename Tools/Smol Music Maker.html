<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smol Music Maker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f0f0f0; --card: #ffffff; --blue: #007aff;
            --off: #d1d1d6; --text: #1d1d1f; --accent: #34c759;
        }
        [data-theme="dark"] {
            --bg-body: #0a0a0a; --card: #1c1c1e; --blue: #5db0ff;
            --off: #3a3a3c; --text: #f5f5f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-body);
            color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px;
        }

        .main-container { display: flex; gap: 20px; max-width: 1200px; width: 100%; margin-top: 20px; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--card); border-radius: 24px;
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .layer-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-body); padding: 10px; border-radius: 12px;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .layer-item.active { border-color: var(--blue); background: rgba(0,122,255,0.1); }
        .layer-info { display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .remove-layer { background: none; border: none; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .remove-layer:hover { opacity: 1; transform: scale(1.2); }

        /* EDITOR AREA */
        .editor { flex-grow: 1; position: relative; }
        #grid {
            display: grid; grid-template-columns: repeat(16, 1fr); gap: 4px;
            background: var(--card); padding: 15px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative;
            overflow: hidden;
        }
        .cell { 
            width: 100%; aspect-ratio: 1/0.7; background: var(--off); 
            border-radius: 6px; cursor: pointer; position: relative; z-index: 1; 
        }
        .cell.active { background: var(--blue); box-shadow: 0 0 8px var(--blue); }
        .cell.layer-ghost { opacity: 0.2; background: var(--blue); }

        /* PLAYHEAD PAR-DESSUS (Z-INDEX 10) */
        #playhead {
            position: absolute; top: 0; bottom: 0; 
            width: calc((100% - 30px) / 16);
            background: rgba(52, 199, 89, 0.3);
            border-left: 3px solid var(--accent);
            pointer-events: none; 
            z-index: 10;
            transition: left 0.1s linear;
        }

        .controls {
            margin-top: 20px; display: flex; gap: 15px; align-items: center;
            background: var(--card); padding: 15px 25px; border-radius: 50px; justify-content: center;
        }
        .btn-icon { font-size: 1.5rem; background: none; border: none; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
        #recBtn.recording { color: #ff3b30; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <h1 style="letter-spacing:-1px">Smol Music Maker</h1>

    <div class="main-container">
        <div class="sidebar">
            <h3 style="font-size: 0.8rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px;">Tracks</h3>
            <div id="layerList"></div>
            <button class="layer-item" onclick="triggerFileUpload()" style="border: 2px dashed #888; background: none; justify-content: center; margin-top: 10px;">
                <span>‚≠ê Add Sample</span>
            </button>
            <input type="file" id="fileInput" accept=".mp3,.wav,.ogg">
        </div>

        <div class="editor">
            <div id="grid">
                <div id="playhead" style="display:none"></div>
            </div>
            
            <div class="controls">
                <button id="playBtn" class="btn-icon">‚ñ∂Ô∏è</button>
                <button id="recBtn" class="btn-icon" title="Record Loop">üî¥</button>
                <button id="clearBtn" class="btn-icon">üóëÔ∏è</button>
                <div style="display:flex; align-items:center; gap:10px; background:var(--bg-body); padding:5px 15px; border-radius:20px;">
                    <span style="font-size:0.8rem">‚è±Ô∏è</span>
                    <input type="range" id="tempo" min="60" max="240" value="120">
                </div>
                <button onclick="toggleTheme()" class="btn-icon" id="themeBtn">üåô</button>
            </div>
        </div>
    </div>

    <script>
        const ROWS = 12, COLS = 16;
        const frequencies = [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88].reverse();
        
        let layers = [
            { name: 'Piano', icon: 'üéπ', type: 'square', data: Array(ROWS).fill().map(() => Array(COLS).fill(false)), buffer: null },
            { name: 'Bass', icon: 'üé∏', type: 'triangle', data: Array(ROWS).fill().map(() => Array(COLS).fill(false)), buffer: null }
        ];
        
        let activeIndex = 0;
        let isPlaying = false, isRecording = false, currentStep = 0, scheduler = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const mainGain = audioCtx.createGain();
        mainGain.connect(audioCtx.destination);
        const dest = audioCtx.createMediaStreamDestination();
        mainGain.connect(dest);

        const mediaRecorder = new MediaRecorder(dest.stream);
        let chunks = [];
        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'smol_track.wav';
            a.click();
        };

        function triggerFileUpload() { document.getElementById('fileInput').click(); }

        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                layers.push({
                    name: file.name.substring(0, 8),
                    icon: '‚≠ê',
                    type: 'sample',
                    data: Array(ROWS).fill().map(() => Array(COLS).fill(false)),
                    buffer: audioBuffer
                });
                activeIndex = layers.length - 1;
                updateUI();
            } catch (err) { alert("Error loading audio file."); }
        };

        function removeLayer(idx, e) {
            e.stopPropagation();
            if (layers.length <= 1) return;
            layers.splice(idx, 1);
            if (activeIndex >= layers.length) activeIndex = layers.length - 1;
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('layerList');
            list.innerHTML = '';
            layers.forEach((l, i) => {
                const div = document.createElement('div');
                div.className = `layer-item ${i === activeIndex ? 'active' : ''}`;
                div.onclick = () => { activeIndex = i; updateUI(); };
                div.innerHTML = `
                    <div class="layer-info"><span>${l.icon}</span> ${l.name}</div>
                    <button class="remove-layer" onclick="removeLayer(${i}, event)">‚ùå</button>
                `;
                list.appendChild(div);
            });
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const playhead = document.getElementById('playhead');
            grid.innerHTML = '';
            grid.appendChild(playhead);

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (layers[activeIndex].data[r][c]) cell.classList.add('active');
                    const hasOther = layers.some((l, i) => i !== activeIndex && l.data[r][c]);
                    if (hasOther && !layers[activeIndex].data[r][c]) cell.classList.add('layer-ghost');

                    cell.onclick = () => {
                        layers[activeIndex].data[r][c] = !layers[activeIndex].data[r][c];
                        if(layers[activeIndex].data[r][c]) playNote(r, activeIndex);
                        renderGrid();
                    };
                    grid.appendChild(cell);
                }
            }
        }

        function movePlayhead() {
            const ph = document.getElementById('playhead');
            if (!isPlaying) { ph.style.display = 'none'; return; }
            ph.style.display = 'block';
            ph.style.left = `calc(15px + (${currentStep} * (100% - 30px) / 16))`;
        }

        function playNote(row, layerIdx) {
            const layer = layers[layerIdx];
            const freq = frequencies[row];

            if (layer.type === 'sample' && layer.buffer) {
                const source = audioCtx.createBufferSource();
                source.buffer = layer.buffer;
                source.playbackRate.value = freq / 261.63; 
                source.connect(mainGain);
                source.start(0);
            } else {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = layer.type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
                osc.connect(g); g.connect(mainGain);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        function nextStep() {
            if(!isPlaying) return;
            const tempo = document.getElementById('tempo').value;
            layers.forEach((layer, lIdx) => {
                for (let r = 0; r < ROWS; r++) {
                    if (layer.data[r][currentStep]) playNote(r, lIdx);
                }
            });
            movePlayhead();
            if (isRecording && currentStep === COLS - 1) {
                setTimeout(() => { 
                    isRecording = false; 
                    document.getElementById('recBtn').classList.remove('recording');
                    mediaRecorder.stop(); 
                    stopEngine(); 
                }, 500);
                return;
            }
            currentStep = (currentStep + 1) % COLS;
            scheduler = setTimeout(nextStep, (60 / tempo / 4) * 1000);
        }

        function stopEngine() { 
            isPlaying = false; 
            clearTimeout(scheduler); 
            currentStep = 0; 
            movePlayhead(); 
            document.getElementById('playBtn').innerText = '‚ñ∂Ô∏è'; 
        }

        document.getElementById('playBtn').onclick = () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            document.getElementById('playBtn').innerText = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            if (isPlaying) nextStep(); else stopEngine();
        };

        document.getElementById('recBtn').onclick = () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            stopEngine(); isRecording = true; isPlaying = true; chunks = [];
            document.getElementById('recBtn').classList.add('recording');
            mediaRecorder.start(); nextStep();
        };

        document.getElementById('clearBtn').onclick = () => {
            layers[activeIndex].data.forEach(row => row.fill(false));
            renderGrid();
        };

        function toggleTheme() {
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        window.onload = () => {
            document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
            updateUI();
        };
    </script>
</body>
</html>

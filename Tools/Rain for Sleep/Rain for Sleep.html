<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rain for Sleep | 3D Lines & Legacy</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Inter', sans-serif; color: white; }
        .ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 100; background: rgba(0, 0, 0, 0.8); padding: 20px;
            border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center; min-width: 320px;
        }
        .slider-group { margin: 10px 0; display: flex; flex-direction: column; align-items: center; }
        .btn-toggle {
            background: #007aff; color: white; border: none; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px;
        }
        input[type=range] { width: 80%; cursor: pointer; accent-color: #007aff; }

        #experience-3d { position: absolute; width: 100%; height: 100%; z-index: 1; }
        #legacy-version { 
            display: none; position: absolute; width: 100%; height: 100%; 
            z-index: 2; background: #000; 
        }

        /* LEGACY - LIGNES BLANCHES ORIGINALES */
        .rain-legacy {
            position: absolute; width: 100%; height: 100%;
            background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 100% 50px; animation: rain-fall 0.3s linear infinite;
        }
        @keyframes rain-fall { from { background-position: 0 0; } to { background-position: 0 50px; } }
    </style>
</head>
<body>

    <div id="experience-3d"></div>

    <div id="legacy-version">
        <div class="rain-legacy"></div>
    </div>

    <div class="ui-panel">
        <h2 id="txt-title">Rain for Sleep</h2>
        <div class="slider-group">
            <label id="txt-rain-vol">Rain Volume</label>
            <input type="range" id="rainVol" min="0" max="1" step="0.01" value="0.7">
        </div>
        <div class="slider-group">
            <label id="txt-thunder-vol">Thunder Volume</label>
            <input type="range" id="thunderVol" min="0" max="1" step="0.01" value="0.5">
        </div>
        <button class="btn-toggle" onclick="toggleVersion()" id="txt-btn-toggle">Switch to Legacy</button>
    </div>

    <audio id="rainAudio" src="https://raw.githubusercontent.com/Stormwindsky/Stormwindsky-Website/main/Tools/Rain%20for%20Sleep/Rain%20sfx.wav" loop></audio>
    <audio id="thunderAudio" src="https://github.com/Stormwindsky/Stormwindsky-website-the-part-under-license-by-sa-4.0/raw/main/sfx/Thunder/Thunder.wav" loop></audio>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        const translations = {
            'en': { title: "Rain for Sleep 3D", rain: "Rain Volume", thunder: "Thunder Volume", btnLegacy: "Switch to Legacy", btn3D: "Switch to 3D" },
            'fr-FR': { title: "Pluie 3D", rain: "Volume Pluie", thunder: "Volume Tonnerre", btnLegacy: "Version Legacy", btn3D: "Version 3D" },
            'fr-CA': { title: "Pluie 3D", rain: "Volume Pluie", thunder: "Volume Tonnerre", btnLegacy: "Version Legacy", btn3D: "Version 3D" },
            'es-ES': { title: "Lluvia 3D", rain: "Volumen Lluvia", thunder: "Volumen Trueno", btnLegacy: "Versión Legacy", btn3D: "Versión 3D" }
        };

        const currentLang = localStorage.getItem('preferredLang') || 'en';
        const t = translations[currentLang] || translations['en'];

        const updateUI = (is3D) => {
            document.getElementById('txt-title').innerText = is3D ? t.title : t.title.replace("3D", "Legacy");
            document.getElementById('txt-btn-toggle').innerText = is3D ? t.btnLegacy : t.btn3D;
        };
        updateUI(true);

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.15);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.6, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('experience-3d').appendChild(renderer.domElement);

        // --- PLUIE MODERNE : VRAIES LIGNES (PAS DE CUBES) ---
        const rainCount = 5000;
        const lineGeometry = new THREE.BufferGeometry();
        const linePositions = new Float32Array(rainCount * 6); // 2 points (début et fin) par ligne

        for(let i=0; i < rainCount * 6; i+=6) {
            let x = (Math.random() - 0.5) * 60;
            let y = Math.random() * 40;
            let z = (Math.random() - 0.5) * 60;
            
            linePositions[i] = x;     linePositions[i+1] = y;     linePositions[i+2] = z;     // Haut de la ligne
            linePositions[i+3] = x;   linePositions[i+4] = y - 0.8; linePositions[i+5] = z;   // Bas de la ligne
        }

        lineGeometry.setAttribute('position', new THREE.BufferAttribute(linePositions, 3));
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x007aff, transparent: true, opacity: 0.5 });
        const rainLines = new THREE.LineSegments(lineGeometry, lineMaterial);
        scene.add(rainLines);

        // SPLASHES
        const splashGeo = new THREE.RingGeometry(0.01, 0.05, 10);
        const splashMat = new THREE.MeshBasicMaterial({ color: 0x007aff, transparent: true, opacity: 0.5, side: THREE.DoubleSide });
        const splashes = [];
        for(let i=0; i<80; i++) {
            const s = new THREE.Mesh(splashGeo, splashMat.clone());
            s.rotation.x = Math.PI/2;
            s.visible = false;
            scene.add(s);
            splashes.push(s);
        }

        const rainAudio = document.getElementById('rainAudio');
        const thunderAudio = document.getElementById('thunderAudio');
        document.body.addEventListener('click', () => { rainAudio.play(); thunderAudio.play(); }, {once: true});

        document.getElementById('rainVol').oninput = (e) => rainAudio.volume = e.target.value;
        document.getElementById('thunderVol').oninput = (e) => thunderAudio.volume = e.target.value;

        function animate() {
            requestAnimationFrame(animate);
            const pos = lineGeometry.attributes.position.array;
            
            for(let i=0; i < pos.length; i+=6) {
                pos[i+1] -= 1.0; // Vitesse de chute
                pos[i+4] -= 1.0;

                if(pos[i+1] < 0) {
                    pos[i+1] = 40;
                    pos[i+4] = 39.2;
                    
                    const s = splashes.find(sp => !sp.visible);
                    if(s) {
                        s.position.set(pos[i], 0.01, pos[i+2]);
                        s.visible = true;
                        s.scale.set(1, 1, 1);
                        s.material.opacity = 0.5;
                    }
                }
            }
            lineGeometry.attributes.position.needsUpdate = true;
            
            splashes.forEach(s => {
                if(s.visible) {
                    s.scale.x += 0.2; s.scale.y += 0.2;
                    s.material.opacity -= 0.04;
                    if(s.material.opacity <= 0) s.visible = false;
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        window.toggleVersion = () => {
            const v3d = document.getElementById('experience-3d');
            const vLegacy = document.getElementById('legacy-version');
            const is3D = v3d.style.display !== 'none';
            v3d.style.display = is3D ? 'none' : 'block';
            vLegacy.style.display = is3D ? 'block' : 'none';
            updateUI(!is3D);
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

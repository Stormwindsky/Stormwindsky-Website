<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snow for Sleep | 3D & Legacy</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: Arial, sans-serif; color: white; }
        
        /* UI PANEL */
        .ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0, 0, 0, 0.8); padding: 20px;
            border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center; min-width: 320px;
        }
        .slider-group { margin: 10px 0; display: flex; flex-direction: column; align-items: center; }
        .btn-toggle, .btn-credits {
            background: #ffffff; color: #000; border: none; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-weight: bold; margin: 5px;
        }
        input[type=range] { width: 80%; cursor: pointer; accent-color: #ffffff; }

        /* VIEWS */
        #experience-3d { position: absolute; width: 100%; height: 100%; z-index: 1; background: #000; }
        
        /* STYLE LEGACY REPRIS DE TON FICHIER */
        #legacy-version { 
            display: none; position: absolute; width: 100%; height: 100%; 
            z-index: 2; 
            background-image: url('https://raw.githubusercontent.com/Stormwindsky/Stormwindsky-Website/refs/heads/main/Tools/Snow%20for%20sleep/Snow.jpg');
            background-size: cover; background-position: center;
        }
        #legacy-version::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 0;
        }

        .snowflake {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
        }
        @keyframes fall {
            0% { top: -10px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100vh; opacity: 0; }
        }

        /* MODAL DES CREDITS (TON TEXTE SOURCE) */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); overflow-y: auto;
        }
        .modal-content {
            background-color: #1c1c1e; margin: 5% auto; padding: 30px; border: 1px solid #333;
            width: 80%; max-width: 700px; border-radius: 20px; line-height: 1.6;
            text-align: left;
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="experience-3d"></div>
    <div id="legacy-version"></div>

    <div class="ui-panel">
        <h2 id="txt-title">Snow for Sleep</h2>
        <div class="slider-group">
            <label id="txt-snow-vol">Wind Volume</label>
            <input type="range" id="snowVol" min="0" max="1" step="0.01" value="0.5">
        </div>
        <button class="btn-toggle" onclick="toggleVersion()" id="txt-btn-toggle">Switch to Legacy</button>
        <button class="btn-credits" onclick="openModal()">Notes & Credits</button>
    </div>

    <div id="creditsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Notes & Credits</h2>
            <p><strong>I. Visual Artwork</strong><br>Artwork Title: Snow on the Sumida River (Sumida), from the series, Snow, Moon, and Flowers (Setsugekka)<br>Artist: Katsushika Hokusai (Japanese, 1760–1849)<br>Status: Public Domain (CC0)</p>
            <p><strong>II. Audio Source</strong><br>Sound Title: Howling winter storm ambient sounds<br>Artist: DBlover<br>Credit: Howling winter storm ambient sounds (505999) by DBlover, licensed under Creative Commons Zero (CC0) on Freesound.</p>
            <p><strong>III. Webpage License</strong><br>The Webpage Code is licensed under the MIT License.</p>
        </div>
    </div>

    <audio id="snowAudio" src="https://raw.githubusercontent.com/Stormwindsky/Stormwindsky-Website/main/Tools/Snow%20for%20sleep/whiter.wav" loop></audio>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        // --- 3D ENGINE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('experience-3d').appendChild(renderer.domElement);

        const snowCount = 6000;
        const snowGeo = new THREE.BufferGeometry();
        const snowPos = new Float32Array(snowCount * 3);
        const velocities = [];
        for(let i=0; i<snowCount*3; i+=3) {
            snowPos[i]=(Math.random()-0.5)*40; snowPos[i+1]=(Math.random()-0.5)*40; snowPos[i+2]=(Math.random()-0.5)*40;
            velocities.push({ y: 0.01+Math.random()*0.02, x: 0.1+Math.random()*0.15 });
        }
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
        const snowMap = new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/sprites/circle.png');
        const snowMat = new THREE.PointsMaterial({ size: 0.07, map: snowMap, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false });
        const snow = new THREE.Points(snowGeo, snowMat);
        scene.add(snow);

        function animate() {
            requestAnimationFrame(animate);
            if (document.getElementById('experience-3d').style.display !== 'none') {
                const pos = snowGeo.attributes.position.array;
                for(let i=0; i<snowCount; i++) {
                    const idx=i*3; pos[idx]-=velocities[i].x; pos[idx+1]-=velocities[i].y;
                    if(pos[idx+1]<-20) pos[idx+1]=20; if(pos[idx]<-20) pos[idx]=20;
                }
                snowGeo.attributes.position.needsUpdate = true;
                renderer.render(scene, camera);
            }
        }
        animate();

        // --- LEGACY ENGINE (TON SCRIPT ORIGINAL RE-FIXÉ) ---
        const vLegacy = document.getElementById('legacy-version');
        const numberOfSnowflakes = 100;

        function createSnowflake() {
            const snowflake = document.createElement('span');
            snowflake.classList.add('snowflake');
            const size = Math.random() * 5 + 2 + 'px';
            snowflake.style.width = size;
            snowflake.style.height = size;
            snowflake.style.left = Math.random() * 100 + 'vw';
            const duration = Math.random() * 10 + 5;
            snowflake.style.animation = `fall ${duration}s linear infinite`;
            const delay = Math.random() * -duration;
            snowflake.style.animationDelay = `${delay}s`;
            const windStrength = Math.random() * 10 - 5;
            snowflake.style.transform = `translateX(${windStrength}px)`;
            
            vLegacy.appendChild(snowflake);
        }

        window.toggleVersion = () => {
            const v3d = document.getElementById('experience-3d');
            const is3D = v3d.style.display !== 'none';
            
            if (is3D) {
                v3d.style.display = 'none';
                vLegacy.style.display = 'block';
                for (let i = 0; i < numberOfSnowflakes; i++) { createSnowflake(); }
            } else {
                v3d.style.display = 'block';
                vLegacy.style.display = 'none';
                vLegacy.innerHTML = ''; // Nettoie les flocons au switch
            }
        };

        const snowAudio = document.getElementById('snowAudio');
        document.body.addEventListener('click', () => snowAudio.play(), {once: true});
        document.getElementById('snowVol').oninput = (e) => snowAudio.volume = e.target.value;
        window.openModal = () => document.getElementById('creditsModal').style.display = "block";
        window.closeModal = () => document.getElementById('creditsModal').style.display = "none";
        window.onclick = (e) => { if(e.target == document.getElementById('creditsModal')) closeModal(); }
    </script>
</body>
</html>
